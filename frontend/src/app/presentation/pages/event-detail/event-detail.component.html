<div>
  @if (event(); as currentEvent) {
  <header class="d-flex align-items-center justify-content-between mb-4">
    <div>
      <a routerLink="/events" class="small text-muted text-decoration-none">&larr; Back to Events</a>
      <h1 class="display-6 fw-bold text-dark mt-1">{{ currentEvent.title }}</h1>
      <div class="d-flex align-items-center mt-2">
        <span class="badge rounded-pill me-3" [class]="getBadgeClass(currentEvent.status)">
          {{ currentEvent.status }}
        </span>
        <span class="small text-muted">Last updated by {{ currentEvent.updatedBy }}</span>
      </div>
    </div>
    @if (!isReadOnly()) {
    <button (click)="saveChanges()" class="btn btn-danger fw-semibold px-4 py-2" [disabled]="eventForm.pristine">
      Save Changes
    </button>
    }
  </header>

  <div class="row g-4">
    <!-- Main Content -->
    <div class="col-lg-8">
      <div class="card shadow-sm">
        <div class="card-body p-4">
          <form [formGroup]="eventForm">
            <div class="mb-3">
              <label for="title" class="form-label">Title <span class="text-danger">*</span></label>
              <input type="text" id="title" formControlName="title" class="form-control"
                [class.is-invalid]="eventForm.get('title')?.invalid && eventForm.get('title')?.touched">
              <div class="invalid-feedback">Title is required.</div>
            </div>
            <div class="row g-3 mb-3">
              <div class="col-md-6">
                <label for="eventDate" class="form-label">Event Date <span class="text-danger">*</span></label>
                <input type="date" id="eventDate" formControlName="eventDate" class="form-control"
                  [class.is-invalid]="eventForm.get('eventDate')?.invalid && eventForm.get('eventDate')?.touched">
                <div class="invalid-feedback">Date is required.</div>
              </div>
              <div class="col-md-6">
                <label for="organizerTeam" class="form-label">Organizer Team <span class="text-danger">*</span></label>
                <input type="text" id="organizerTeam" formControlName="organizerTeam" class="form-control"
                  [class.is-invalid]="eventForm.get('organizerTeam')?.invalid && eventForm.get('organizerTeam')?.touched">
                <div class="invalid-feedback">Organizer Team is required.</div>
              </div>
            </div>
            <!-- Removed Department as it's not in backend schema -->
            <div>
              <label for="description" class="form-label">Description</label>
              <textarea id="description" formControlName="description" rows="10" class="form-control"></textarea>
            </div>

            <div class="mt-4 pt-3 border-top small text-muted">
              <p class="mb-1">Created: {{ currentEvent.createdAt | date:'medium' }} by ID: {{ currentEvent.createdBy }}
              </p>
              <p class="mb-0">Last Updated: {{ currentEvent.updatedAt | date:'medium' }}</p>
            </div>
          </form>
        </div>
      </div>
    </div>

    <!-- Attendance & Metadata -->
    <div class="col-lg-4">
      <div class="card shadow-sm">
        <div class="card-body p-4">
          <h2 class="h5 fw-semibold text-dark mb-3">Attendance</h2>

          @if (!isReadOnly()) {
          <div class="mb-4">
            <p class="small text-muted">Upload Microsoft Teams attendance file (CSV/Excel).</p>
            <input type="file" (change)="onFileSelected($event)" class="form-control"
              accept=".csv, application/vnd.openxmlformats-officedocument.spreadsheetml.sheet, application/vnd.ms-excel">
            <div class="alert alert-warning mt-3 small">
              Attendance upload is mandatory before marking an event as COMPLETED.
            </div>
          </div>
          }

          @if (currentEvent.attendance && currentEvent.attendance.length > 0) {
          <div>
            <div class="d-flex justify-content-between align-items-center mb-2">
              <h3 class="h6 text-dark mb-0">Attendees ({{currentEvent.totalAttendees}})</h3>
              <span class="small text-muted">{{currentEvent.totalMinutes.toLocaleString()}} total mins</span>
            </div>
            <div class="table-responsive border rounded" style="max-height: 250px; overflow-y: auto;">
              <table class="table table-sm table-striped mb-0">
                <thead class="table-light">
                  <tr>
                    <th scope="col" class="small fw-medium ps-3">Name</th>
                    <th scope="col" class="small fw-medium text-end pe-3">Duration</th>
                  </tr>
                </thead>
                <tbody>
                  @for(attendee of currentEvent.attendance; track attendee.email) {
                  <tr>
                    <td class="small ps-3">{{ attendee.name }}</td>
                    <td class="small text-end pe-3">{{ attendee.duration }} min</td>
                  </tr>
                  }
                </tbody>
              </table>
            </div>
          </div>
          } @else {
          <div class="text-center bg-light rounded p-4">
            <p class="text-muted small mb-0">No attendance data has been uploaded for this event.</p>
          </div>
          }
        </div>
      </div>
    </div>
  </div>
  } @else {
  <div class="text-center py-5">
    <p class="text-muted">Event not found.</p>
  </div>
  }
</div>